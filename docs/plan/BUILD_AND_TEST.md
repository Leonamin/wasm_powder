# 빌드 및 테스트 가이드

## 🔨 빌드 방법

### Windows (현재 환경)

```batch
# 프로젝트 루트에서 실행
build.bat
```

빌드가 성공하면 다음 파일이 생성됩니다:
- `web/simulation.js`
- `web/simulation.wasm`

### 빌드 오류 해결

#### Emscripten 미설치
```
❌ Error: Emscripten (emcc) not found!
```

**해결:**
1. [Emscripten 다운로드](https://emscripten.org/docs/getting_started/downloads.html)
2. `emsdk_env.bat` 실행하여 환경 설정

#### 헤더 파일 오류
```
fatal error: 'material_db.h' file not found
```

**해결:**
- `src/material_db.h` 파일이 존재하는지 확인
- `build.bat`에 `-I src` 옵션이 있는지 확인

---

## 🚀 실행 방법

### 1. 개발 서버 시작

```batch
cd web
python -m http.server 8000
```

또는 Node.js 사용:
```batch
cd web
npx http-server -p 8000
```

### 2. 브라우저에서 열기

http://localhost:8000

---

## 🧪 테스트 시나리오

### 테스트 1: 기본 동작 확인

**목적:** 시뮬레이션이 정상적으로 작동하는지 확인

**절차:**
1. 브라우저에서 페이지 열기
2. "⏳ 모래 (SAND)" 선택
3. 캔버스에 마우스 드래그
4. 모래가 아래로 떨어지는지 확인

**예상 결과:**
- ✅ 모래가 중력에 따라 아래로 떨어짐
- ✅ 바닥에 쌓임

---

### 테스트 2: 마우스 Pressed 버그 수정 확인

**목적:** 마우스를 누르고 있으면 계속 입자가 생성되는지 확인

**절차:**
1. "⏳ 모래 (SAND)" 선택
2. 캔버스의 한 지점에 마우스를 누르고 **움직이지 않기**
3. 2-3초 대기

**예상 결과:**
- ✅ 마우스를 움직이지 않아도 계속 모래가 생성됨
- ✅ 같은 위치에 모래가 쌓임

**이전 버전 (버그):**
- ❌ 클릭 시 한 번만 생성되고 멈춤

---

### 테스트 3: 열 전도 (배경 개념)

**목적:** EMPTY 셀을 통해 열이 퍼지는지 확인

**절차:**
1. "물질 타입" 모드에서 시작
2. "🔥 불 (FIRE)" 선택
3. 캔버스 중앙에 불 입자 하나 추가
4. **"온도" 모드로 전환**
5. 열이 퍼지는 모습 관찰
6. "🗑️ 지우개"로 불 제거
7. 열이 남아있는지 확인

**예상 결과:**
- ✅ 불 주변이 빨간색(뜨거움)으로 표시
- ✅ 시간이 지나면서 열이 주변으로 퍼짐 (빨강 → 노랑 → 초록)
- ✅ 불을 제거해도 열은 그 자리에 남음
- ✅ 서서히 식어서 파란색(차가움)으로 변함

**색상 가이드:**
- 🔴 빨강: 뜨거움 (100°C 이상)
- 🟡 노랑: 따뜻함 (50-100°C)
- 🟢 초록: 보통 (20-50°C)
- 🔵 파랑: 차가움 (0-20°C)
- 🟣 보라: 매우 차가움 (-20-0°C)

---

### 테스트 4: 상태 전이 (물 ↔ 얼음 ↔ 증기)

**목적:** 온도에 따라 물질이 변하는지 확인

**절차 A: 얼음 녹이기**
1. "🧊 얼음 (ICE)" 선택하여 추가
2. "🔥 불 (FIRE)" 선택하여 얼음 옆에 추가
3. 물질 타입 모드에서 관찰

**예상 결과:**
- ✅ 얼음(하늘색)이 물(파랑)로 변함
- ✅ 물이 아래로 흐름

**절차 B: 물 끓이기**
1. "💧 물 (WATER)" 추가
2. "🔥 불 (FIRE)"로 가열
3. 관찰

**예상 결과:**
- ✅ 물(파랑)이 증기(흰색)로 변함
- ✅ 증기가 위로 올라감

**절차 C: 증기 냉각**
1. "💨 증기 (STEAM)" 추가
2. "❄️ 냉기 (FROST)"로 냉각
3. 관찰

**예상 결과:**
- ✅ 증기(흰색)가 물(파랑)로 변함
- ✅ 물이 얼음(하늘색)으로 변함

---

### 테스트 5: 밀도 기반 교환

**목적:** 밀도가 높은 물질이 낮은 물질을 뚫고 가라앉는지 확인

**절차:**
1. "💧 물 (WATER)" 선택
2. 캔버스 하단에 물 추가 (높이 약 50픽셀)
3. "⏳ 모래 (SAND)" 선택
4. 물 위에 모래 추가
5. 관찰

**예상 결과:**
- ✅ 모래가 물을 뚫고 아래로 가라앉음
- ✅ 물이 위로 밀려남

**밀도 참고:**
- SAND: 1600 kg/m³
- WATER: 1000 kg/m³
- ICE: 917 kg/m³ (물보다 낮음!)
- STEAM: 0.6 kg/m³

---

### 테스트 6: 온도 이동

**목적:** 입자가 이동할 때 온도도 함께 이동하는지 확인

**절차:**
1. "온도" 모드로 전환
2. "⏳ 모래 (SAND)" 선택
3. 캔버스 상단에 모래 추가 (초록색, 20°C)
4. "🔥 불 (FIRE)" 선택
5. 모래 옆에 불 추가하여 가열 (빨간색, 150°C)
6. 뜨거운 모래가 아래로 떨어지는 모습 관찰

**예상 결과:**
- ✅ 모래가 가열되어 빨간색으로 변함
- ✅ 빨간색 모래가 아래로 떨어짐
- ✅ 떨어진 위치에 열이 전달됨

**추가 테스트:**
1. 뜨거운 모래를 물에 떨어뜨리기
2. 온도 모드에서 물이 데워지는지 확인

---

### 테스트 7: 렌더링 모드 전환

**목적:** 두 렌더링 모드가 정상 작동하는지 확인

**절차:**
1. 다양한 물질 추가 (SAND, WATER, FIRE, ICE)
2. "물질 타입" 버튼 클릭
3. 각 물질의 고유 색상 확인
4. "온도" 버튼 클릭
5. 온도에 따른 색상 확인

**예상 결과:**
- ✅ 물질 타입 모드: 각 물질이 고유 색상으로 표시
  - SAND: 카키색
  - WATER: 파랑
  - FIRE: 주황/빨강
  - ICE: 하늘색
- ✅ 온도 모드: 온도에 따라 색상 변화
  - FIRE: 빨강 (150°C)
  - ICE: 파랑 (-10°C)
  - SAND, WATER: 초록 (20°C)

---

## 🐛 알려진 문제 및 해결

### 문제 1: 페이지가 로드되지 않음

**증상:**
```
⏳ WebAssembly 모듈 로딩 중...
```
화면에서 멈춤

**원인:**
- `simulation.js` 또는 `simulation.wasm` 파일이 없음
- CORS 오류 (파일 직접 열기)

**해결:**
1. `build.bat` 실행했는지 확인
2. 반드시 로컬 서버 사용 (파일 직접 열기 X)
3. 브라우저 콘솔(F12) 확인

---

### 문제 2: 입자가 움직이지 않음

**증상:**
- 입자를 추가해도 떨어지지 않음
- 화면이 정지됨

**원인:**
- JavaScript 오류
- Wasm 함수 호출 실패

**해결:**
1. 브라우저 콘솔(F12) 확인
2. 빌드 시 모든 함수가 export되었는지 확인
3. `build.bat`의 `EXPORTED_FUNCTIONS` 확인

---

### 문제 3: 온도 모드에서 화면이 깜빡임

**증상:**
- 온도 모드로 전환 시 FPS 저하
- 화면이 깜빡거림

**원인:**
- Particle 구조체 접근 오버헤드
- 400x300 = 120,000번 메모리 읽기

**해결 (임시):**
- 물질 타입 모드 사용
- 그리드 크기 축소 (simulation.cpp의 WIDTH, HEIGHT)

**해결 (향후):**
- Active Chunks 최적화
- 렌더링 최적화

---

## 📊 성능 측정

### FPS 확인

브라우저 콘솔(F12)에서:
```javascript
let lastTime = performance.now();
let frameCount = 0;

setInterval(() => {
    const now = performance.now();
    const fps = frameCount / ((now - lastTime) / 1000);
    console.log(`FPS: ${fps.toFixed(1)}`);
    frameCount = 0;
    lastTime = now;
}, 1000);

// gameLoop에서
frameCount++;
```

**목표 FPS:**
- 물질 타입 모드: 60 FPS
- 온도 모드: 30-60 FPS

---

## ✅ 체크리스트

빌드 전:
- [ ] `src/particle.h` 수정 완료
- [ ] `src/material_db.h` 생성 완료
- [ ] `src/simulation.cpp` 교체 완료
- [ ] `web/main.js` 수정 완료
- [ ] `web/index.html` 수정 완료
- [ ] `build.bat` 업데이트 완료

빌드:
- [ ] `build.bat` 실행
- [ ] `web/simulation.js` 생성 확인
- [ ] `web/simulation.wasm` 생성 확인

테스트:
- [ ] 테스트 1: 기본 동작 ✅
- [ ] 테스트 2: 마우스 버그 수정 ✅
- [ ] 테스트 3: 열 전도 ✅
- [ ] 테스트 4: 상태 전이 ✅
- [ ] 테스트 5: 밀도 교환 ✅
- [ ] 테스트 6: 온도 이동 ✅
- [ ] 테스트 7: 렌더링 모드 ✅

---

## 🎯 다음 단계

테스트 완료 후:
1. 버그 발견 시 `PLAN_BUG.md`에 기록
2. 성능 측정 결과 기록
3. `PLAN_BUG_COMPLETED.md`에 해결된 버그 이동
4. 다음 기능 구현 (PLAN_ROADMAP.md 참조)

---

## 📞 문제 발생 시

1. **빌드 로그 확인**
   - 오류 메시지 전체 복사

2. **브라우저 콘솔 확인** (F12)
   - JavaScript 오류 확인
   - Wasm 로드 오류 확인

3. **파일 존재 확인**
   ```batch
   dir src
   dir web
   ```

4. **Emscripten 버전 확인**
   ```batch
   emcc --version
   ```
